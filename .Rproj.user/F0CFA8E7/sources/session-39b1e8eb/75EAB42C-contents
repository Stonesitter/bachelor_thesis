# Load necessary package
library(dplyr)

# Define a function to calculate perseverative errors
calculate_perseverative_error <- function(df) {
  df <- df %>%
    group_by(jatosStudyResultId) %>%
    arrange(total_responses) %>%
    mutate(
      previous_rule = lag(matching_rule),
      # Determine the attributes of the chosen card based on the response
      chosen_color = case_when(
        response == "a" ~ color1,
        response == "b" ~ color2,
        response == "c" ~ color3,
        response == "d" ~ color4,
        TRUE ~ NA_character_
      ),
      chosen_shape = case_when(
        response == "a" ~ shape1,
        response == "b" ~ shape2,
        response == "c" ~ shape3,
        response == "d" ~ shape4,
        TRUE ~ NA_character_
      ),
      chosen_number = case_when(
        response == "a" ~ number1,
        response == "b" ~ number2,
        response == "c" ~ number3,
        response == "d" ~ number4,
        TRUE ~ NA_integer_
      ),
      perseverative_error = case_when(
        response != correct_response & !is.na(previous_rule) & (
          (previous_rule == "color" & matching_rule != "color" &
             chosen_color == response_color) |
            (previous_rule == "shape" & matching_rule != "shape" &
               chosen_shape == response_shape) |
            (previous_rule == "number" & matching_rule != "number" &
               chosen_number == response_number)
        ) ~ TRUE,
        TRUE ~ FALSE
      )
    ) %>%
    ungroup()
  
  return(df)
}

# Apply the function to your dataframe
look_with_errors <- calculate_perseverative_error(look)

# Display the first few rows of the result
print(head(look_with_errors %>% select(total_responses, matching_rule, previous_rule, response, correct_response, perseverative_error), n = 65))
